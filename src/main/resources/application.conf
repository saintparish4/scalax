server {
    host = "0.0.0.0"
    host = ${?SERVER_HOST}
 
    port = 8080
    port = ${?SERVER_PORT}

    shutdown-timeout = 30 seconds
    shutdown-timeout = ${?SERVER_SHUTDOWN_TIMEOUT}
}

aws {
    region = "us-east-1"
    region = ${?AWS_REGION}

    # Leave empty for real AWS, set to LocalStack URL for local development 
    endpoint = "" 
    endpoint = ${?AWS_ENDPOINT}

    localstack = false
    localstack = ${?USE_LOCALSTACK} 
}

dynamodb {
  rate-limit-table = "rate-limits"
  rate-limit-table = ${?RATE_LIMIT_TABLE}

  idempotency-table = "idempotency"
  idempotency-table = ${?IDEMPOTENCY_TABLE}

  max-retries = 3
  connection-timeout = 5 seconds
  request-timeout = 10 seconds 
}

kinesis {
  stream-name = "rate-limit-events"
  stream-name = ${?KINESIS_STREAM}

  enabled = true
  enabled = ${?KINESIS_ENABLED}

  batch-size = 100
  flush-interval = 1 second 
  max-retries = 3 
}

rate-limit {
  default-capacity = 100
  default-capacity = ${?RATELIMIT_DEFAULT_CAPACITY} 

  default-refill-rate-per-second = 10.0
  default-refill-rate-per-second = ${?RATELIMIT_DEFAULT_REFILL_RATE} 

  default-ttl-seconds = 3600
  max-cost = 100 

  # Named rate limit profiles for different client tiers 
  profiles {
    free {
      capacity = 20 
      refill-rate-per-second = 2.0 
      ttl-seconds = 3600  
    }

    basic {
      capacity = 100 
      refill-rate-per-second = 10.0 
      ttl-seconds = 3600   
    }

    premium {
      capacity = 1000 
      refill-rate-per-second = 100.0 
      ttl-seconds = 3600    
    }

    enterprise {
      capacity = 10000 
      refill-rate-per-second = 1000.0 
      ttl-seconds = 3600    
    }
  }
}

# ==============================
# Resilience configuration
# ==============================

resilience {
  circuit-breaker {
    enabled = true
    enabled = ${?CIRCUIT_BREAKER_ENABLED}

    dynamodb {
      max-failures = 5
      reset-timeout = 30 seconds
      half-open-max-calls = 3 
    }

    kinesis {
      max-failures = 5 
      reset-timeout = 30 seconds
      half-open-max-calls = 3  
    }
  }

  retry {
    dynamodb {
      max-retries = 3 
      base-delay = 100 milliseconds
      max-delay = 10 seconds
      multiplier = 2.0 
    }

    kinesis {
      max-retries = 3 
      base-delay = 100 milliseconds
      max-delay = 5 seconds 
      multiplier = 2.0  
    }
  }

  bulkhead {
    enabled = true
    enabled = ${?BULKHEAD_ENABLED}

    max-concurrent = 100 
    max-concurrent = ${?BULKHEAD_MAX_CONCURRENT} 

    max-wait = 500 milliseconds 
  }

  timeout {
    rate-limit-check = 100 milliseconds
    idempotency-check = 100 milliseconds
    health-check = 5 seconds 
  }
}

# ==============================
# Security configuration
# ==============================

security {
  authentication {
    enabled = true
    enabled = ${?AUTH_ENABLED}
    
    header-name = "Authorization"
    api-key-prefix = "Bearer"
    
    # Rate limiting on the rate limiter (meta!)
    rate-limit-per-minute = 1000
    max-failed-attempts = 10
  }
  
  secrets {
    enabled = false
    enabled = ${?SECRETS_MANAGER_ENABLED}
    
    secret-prefix = "rate-limiter"
    secret-prefix = ${?SECRETS_PREFIX}
    
    api-keys-secret-name = "api-keys"
    cache-ttl = 5 minutes
  }
}

# ==============================
# Metrics configuration
# ==============================

metrics {
  enabled = true
  enabled = ${?METRICS_ENABLED}
  
  namespace = "RateLimiter"
  namespace = ${?METRICS_NAMESPACE}
  
  flush-interval = 60 seconds
  
  # High resolution (1-second) metrics cost extra in CloudWatch
  high-resolution = false
  high-resolution = ${?METRICS_HIGH_RESOLUTION}
}

# ==============================
# Cache configuration
# ==============================

cache {
  enabled = true
  enabled = ${?CACHE_ENABLED}
  
  max-size = 10000
  max-size = ${?CACHE_MAX_SIZE}
  
  ttl = 1 second
  ttl = ${?CACHE_TTL}
  
  record-stats = true
}
